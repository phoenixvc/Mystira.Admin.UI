name: "Admin UI: Build & Deploy Dev"

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  NODE_VERSION: "20"

jobs:
  # ============================================
  # CI Jobs (run in parallel for fast feedback)
  # ============================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint

  test:
    name: Test
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || !github.event.pull_request.draft
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
      - run: pnpm install --frozen-lockfile
      - run: pnpm test

  # ============================================
  # Build Static Assets
  # ============================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build for dev
        run: pnpm build
        env:
          VITE_API_URL: ${{ vars.VITE_API_URL_DEV }}
          VITE_ENVIRONMENT: dev

      - name: Upload build artifact
        uses: actions/upload-artifact@v6
        with:
          name: admin-ui-dist-dev
          path: dist
          retention-days: 7

  # ============================================
  # Trigger Workspace Deployment (Dev Only)
  # ============================================
  trigger-workspace-deploy:
    name: Trigger Workspace Deployment
    runs-on: ubuntu-latest
    needs: build
    # Only deploy on push to dev or manual dispatch
    if: |
      needs.build.result == 'success' &&
      (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    environment:
      name: dev
      url: https://dev.admin.mystira.app
    steps:
      - name: Trigger deployment via workspace
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.MYSTIRA_GITHUB_SUBMODULE_ACCESS_TOKEN }}
          repository: phoenixvc/Mystira.workspace
          event-type: admin-ui-deploy
          client-payload: |
            {
              "environment": "dev",
              "ref": "${{ github.sha }}",
              "triggered_by": "${{ github.actor }}",
              "run_id": "${{ github.run_id }}",
              "repository": "${{ github.repository }}",
              "submodule_path": "packages/admin-ui",
              "pr_number": ""
            }

  # ============================================
  # Deployment Summary
  # ============================================
  notify:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [lint, test, build, trigger-workspace-deploy]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Actor | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.trigger-workspace-deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.trigger-workspace-deploy.result }}" == "success" ]; then
            echo "### Dev Deployment Triggered" >> $GITHUB_STEP_SUMMARY
            echo "URL: https://dev.admin.mystira.app" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.trigger-workspace-deploy.result }}" == "skipped" ]; then
            echo "### No Deployment" >> $GITHUB_STEP_SUMMARY
            echo "Deployment only runs on push to \`dev\` branch." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Staging/prod deployments are managed through the workspace._" >> $GITHUB_STEP_SUMMARY
